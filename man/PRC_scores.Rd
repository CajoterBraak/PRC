% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/PRC_scores.r
\name{PRC_scores}
\alias{PRC_scores}
\title{Calculates principal response curve (PRC) scores from vegan::rda, cca, dbrda or capscale}
\usage{
PRC_scores(
  object,
  focal_factor_name,
  referencelevel = 1,
  rank = 2,
  flip = rep(FALSE, rank),
  scaling = "ms",
  data
)
}
\arguments{
\item{object}{a \code{vegan} \code{\link[vegan]{cca.object}},
 a result of \code{\link[vegan]{rda}}, \code{\link[vegan]{cca}},
\code{\link[vegan]{dbrda}} or \code{\link[vegan]{capscale}}.}

\item{focal_factor_name}{name of the focal factor (the treatment of interest)}

\item{referencelevel}{numeric level or character (reference level of the focal factor)}

\item{rank}{number of axes to be computed}

\item{flip}{logical value or vector. Should the axes be flipped,
i.e. reversed in orientation? \code{flip} can be numeric with values -1 and 1
for reverse and no reverse, respectively,
i.e. multiply the scores by either -1 or 1.}

\item{scaling}{character ("ms", "ss"). Scales the axes of an RDA object to mean square species scores of 1 ("ms") or
 a sum of squares of 1 ("ss"). The only scaling for a CCA  object is "ss" (weighted mean square = 1, with weigth =
 species total abundance). For a dbrda object, there are no species scores and the scaling is like "ss".
The default scaling ("ms" for RDA and "ss" for CCA) has the advantage that
                  the PRC treatment and sample scores measure the effect sizes of the 'average' species
                  as their (weigthed) mean square is 1 (sd = 1); it is the scaling used in Canoco5 (www.canoco5.com).
                  Scaling "ss" is the default in  \code{\link[stats]{prcomp}}
                  and used in ter Braak 2023}

\item{data}{data frame of the experimental design used in the call
to \code{\link[vegan]{rda}} or \code{\link[vegan]{cca}}}
}
\value{
A named list:
\item{PRCplus}{a data frame that combines the design in \code{data} with the PRC and RDA/CCA scores
                   with ("_E") and without error (the unconstrained [sites] and constrained [LC] scores, respectively),
                   and, finally, the reference scores. Note that
                   PRC1_E = RDA1_E - RDA1_Ref, etc for other axes}
\item{species}{a matrix with the loadings with respect to the PRC scores; NULL if the \code{object} lacks loadings.}
\item{reference_scores}{a matrix with the scores of each unit in \code{data} with the level of the focal factor
 replaced by the reference level}
\item{focal_factor_name}{name of the focal factor in the call to \code{PRC_scores}}
\item{referencelevel}{referencelevel in the call to \code{PRC_scores}}
\item{coefficients}{list of PRC-coefficients for each axis (matrix if rank is equal to 1)}
}
\description{
\code{PRC_scores} calculates scores to display principal response curves with
scores for individual plots from a vegan constrained ordination object (\code{\link[vegan]{cca.object}}).
}
\details{
\code{PRC_scores} uses \code{\link[vegan]{scores}} to
calculate the loadings (species scores),if obtainable from the \code{object}, and the constrained and unconstrained sample scores
of the units in \code{data}. The PRC treatment and sample scores are obtained by subtracting the reference scores
from the constrained and unconstrained scores, respectively.
The reference scores are calculated by applying \code{\link[stats]{predict}}
with \code{type = "lc"} on \code{newdata}, which
equals \code{data}, except that the level of the focal factor of each unit is changed to the reference level.
By this simple method, \code{prc scores} can be applied with and without terms in \code{Condition()}
in the \code{formula} of the call to \code{\link[vegan]{rda}}, \code{\link[vegan]{cca}},
\code{\link[vegan]{dbrda}} or \code{\link[vegan]{capscale}}.
There can thus be additional (perhaps quantitative) covariates,
 \code{A:B+ Condition(A+other_covariates)} where the focal factor is B,
 and also with three (instead of two factors) e.g.
 with formula \code{ A*B*C + Condition(A*C)} so as to display the A*C-dependent effects of focal factor B
 on the multivariate response in the call to \code{\link[vegan]{rda}}, \code{\link[vegan]{cca}},
\code{\link[vegan]{dbrda}} or \code{\link[vegan]{capscale}}.

 CCA-based PRC is useful in data with many zeroes and which are strictly compositional,
 i.e. have row sums that have no meaning for the question of interest (ter Braak and te Beest, 2022).
 A layman's example is that
 the weight of a cake is not important for its taste; taste depends on its composition only.
 CCA can be applied without log-transforming the data and thereby avoids the issue of
 replacement of zeroes (ter Braak and te Beest, 2022).
}
\examples{

data("Ossenkampen")

# Read example data ----------------------------------------------------



Design <- Ossenkampen[,c("A","B","Plot","Block")]
Design$A <- factor(Design$A);  Design$B <- factor(Design$B)
Design$B <- factor(Design$B, levels = c("Cntrl","PK","NPK","N"))
Design$Plot <- Design$Plot
Design$Block <- factor(Design$Block)

print(with(Design,table(A,B)))

# extract response variables
Y <- as.matrix(Ossenkampen[,-(1:5)]); rownames(Y)<-Ossenkampen$Sample
# transform as a multiplicative model is more logical than an additive one.
# But need to add pseudocount to avoid log(0)= infinite
Y <- log(Y+1)

# PRC via vegan -----------------------------------------------------------

myrda <- vegan::rda( Y~ A:B + Condition(A), data = Design)
print(myrda)
#SubtractReferenceValues has been replaced by the function PRC_scores
Design_w_PRCs <- PRC_scores(myrda, focal_factor_name= "B", referencelevel = 1, rank = 2, data= Design)
print(names(Design_w_PRCs))
print(names(Design_w_PRCs$PRCplus))
print(names(Design_w_PRCs$coefficients))
if (is.list(Design_w_PRCs$coefficients)) print(round(Design_w_PRCs$coefficients[[1]], 2)) else
  print(round(Design_w_PRCs$coefficients, 2))
# note that Design_w_PRCs$coefficients is not use for plotting


# prepare data for ggplot2. sc_ref sites and constraints axis  -----------

library(ggplot2)
# convert factor A to numeric and express as years after start
Design_w_PRCs$PRCplus$dyear <- as.numeric(levels(Design_w_PRCs$PRCplus$A))[Design_w_PRCs$PRCplus$A] -1958

pl <- ggplot(Design_w_PRCs$PRCplus,aes(x = dyear, y= PRC1 , color = B))
pl<- pl +
       geom_line(aes(x = dyear, y= PRC1, color = B, group = Plot),linewidth = 1.2)+
       # outcomment the next line if the data points of  'group' are independent
       geom_line(aes(x=dyear, y = PRC1_E, color = B, linetype = Block, group =Plot))+
       geom_point(aes(x=dyear, y = PRC1_E, color = B, shape = Block, group =Plot))

print(pl+
        ggtitle("Ossenkampen PRC1")+
        xlab("factor A: years after start of experiment") +
        ylab("sample scores (T with individual plot lines)")+scale_color_discrete(name = "factor B")
      )


#  species taxa bar plot, first axis --------------------------------------------------
sc_spec <- Design_w_PRCs$species
spec.df <- data.frame("Taxon"=rownames(sc_spec),as.data.frame(sc_spec))
logabu <- colSums(Y)
spec.df100 <- spec.df[logabu >100 & abs(spec.df$RDA1) > 1,]
id <- order(spec.df100$RDA1,decreasing = FALSE)

spec.df100sort <- spec.df100[id,]
spec.df100sort$Taxon <- factor(spec.df100sort$Taxon, levels = spec.df100$Taxon[id])
RDA1.spec <- ggplot(data=spec.df100sort, aes(x=Taxon, y=RDA1)) +
  geom_bar(stat="identity", fill="steelblue")+
  theme_minimal() + coord_flip()
RDA1.spec
# many species scores are positive, while the PRC scores are mostly negative
# so that the conclusion is that many species decrease after N and NPK fertilization
}
\references{
ter Braak (2023) Redundancy analysis includes analysis of variance-simultaneous component analysis (ASCA)
 and outperforms its extensions
Chemometrics and Intelligent Laboratory Systems https://doi.org/10.1016/j.chemolab.2023.104898

ter Braak, C.J.F. & te Beest, D.E. 2022. Testing environmental effects on taxonomic composition
 with canonical correspondence analysis: alternative permutation tests are not equal.
 Environmental and Ecological Statistics. 29 (4), 849-868.
 https://doi.org/10.1007/s10651-022-00545-4

van den Brink, P.J. & ter Braak, C. (1998) Multivariate analysis of stress in experimental ecosystems
 by Principal Response Curves and similarity analysis.
 Aquatic Ecology, 32, 163-178.
 http://dx.doi.org/10.1023/A:1009944004756
van den Brink, P.J. & ter Braak, C.J.F. (1999) Principal Response Curves: Analysis of
 time-dependent multivariate responses of a biological community to stress.
 Environmental Toxicology and Chemistry, 18, 138-148.
 https://doi.org/10.1002/etc.5620180207

van den Brink, P.J., den Besten, P., bij de Vaate, A. & ter Braak, C.J.F. (2009)
 Principal response curves technique for the analysis of multivariate biomonitoring time series.
 Environmental Monitoring and Assessment, 152, 271-281.
 http://dx.doi.org/10.1007/s10661-008-0314-6
}
