% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/doPRC.r
\name{doPRC}
\alias{doPRC}
\title{Perform a Principal Response Curve analysis (PRC)}
\usage{
doPRC(
  formula,
  scale = FALSE,
  referencelevel = NULL,
  rank = 2,
  flip = rep(FALSE, rank),
  scaling = "ms",
  method = "rda",
  data,
  ...
)
}
\arguments{
\item{formula}{formula specifying how the response (species data) must modeled by predictors and covariates.
A typical \code{formula} is \code{Y~treatment*week+Condition(week)},
where \code{Y} is  the global response data matrix or data frame.
Typically these are community (species) data. If count-like, they probably should be log transformed prior to the analysis,
because a multiplicative model has more realism for non-negative data than an additive model.}

\item{scale}{Scales species to unit variance (like correlations) if \code{method} is \code{"rda"}
(default: \code{FALSE}), else void. See \code{\link[vegan]{rda}}.}

\item{referencelevel}{numeric or  character level(s) to be used as reference level or levels
of the focal treatment(s); default: 1 (first level(s)).  The focal treatment is (or treatments are) given in the
resulting list at \code{result$focal_and_conditioning_factors$`focal factor`}}

\item{rank}{number of axes to be computed; default 2.}

\item{flip}{logical value or vector; default: FALSE. Should the axes be flipped,
i.e. reversed in orientation? \code{flip} can be numeric with values -1 and 1
for reverse and no reverse, respectively,
i.e. multiply the scores by either -1 or 1.}

\item{scaling}{character \code{c("ms", "ss")}. Scales the axes of an RDA object to mean square species scores of 1 (\code{"ms"}) or
 a sum of squares of 1 (\code{"ss"}). The only scaling for a CCA  object is \code{"ss"} (weighted mean square = 1, with weight =
 species total abundance). For a dbrda object, there are no species scores and the scaling is like "ss".
The default scaling (\code{"ms"} for RDA and \code{"ss"} for CCA) has the advantage that
                  the PRC treatment and sample scores measure the effect sizes of the 'average' species
                  as their (weigthed) mean square is 1 (sd = 1); it is the scaling used in Canoco5 (www.canoco5.com).
                  Scaling \code{"ss"} is the default in  \code{\link[stats]{prcomp}}
                  and used in ter Braak (2023).}

\item{data}{Data frame containing the variables on the right hand side of the model formula.}
}
\value{
an object as a \code{\link[vegan]{cca.object}} with additional entries as output of \code{\link{PRC_scores}}.
The assigned classes are \code{c("PRC","rda","cca"}.
}
\description{
\code{doPRC} perform a Principal Response Curve analysis (PRC) using the
\code{S3 formula} interface of \code{\link[vegan]{rda}} or \code{\link[vegan]{cca}}
}
\details{
The function performs PRC using \code{\link[vegan]{rda}} or \code{\link[vegan]{cca}} with
the specified \code{formula} and applies \code{\link{PRC_scores}} to the result.
}
\examples{
data(pyrifos, package = "vegan") #log-transformed species data from package vegan
#the chlorpyrifos experiment from van den Brink & ter Braak 1999
Design <- data.frame(week=gl(11, 12, labels=c(-4, -1, 0.1, 1, 2, 4, 8, 12, 15, 19, 24)),
                     dose=factor(rep(c(0.1, 0, 0, 0.9, 0, 44, 6, 0.1, 44, 0.9, 0, 6), 11)),
                     ditch = gl(12, 1, length=132))
#

mod_prc <- doPRC(pyrifos ~ dose:week + Condition(week),  data = Design)
mod_prc$focal_and_conditioning_factors$`focal factor` # as expected: "dose"
print(mod_prc)

#                 Proporti Rank
# Total           1.0000
# Conditional     0.2192   10 (between-week variation)
# Constrained     0.3346   44 (between-treatment variation across weeks)
# Unconstrained   0.4462   77 (within-week variation)

# without lines, threshold is 7
plotPRC(mod_prc)
# this threshold is about P = 0.01 for PRC1 in the regression "species_k ~ week+PRC1"
#                and retains 34 species to be plotted with names
sum(mod_prc$species[,"Fratio1"] >7) # 34
# only the PRC curves:
plotPRC(mod_prc, plot = 0, symbols_on_curves = TRUE)
# with lines and a stronger threshold
plotPRC(mod_prc, plot = "ditch", threshold = 10,width = c(4,1))

# modifying the plot
gg <- plotPRC(mod_prc, plot = "ditch",width = c(4,1), verbose = FALSE)
p1 <- gg$separateplots$treatments + ggplot2::ggtitle(paste("new title:", latex2exp::TeX("$c_{dt}$")))   # PRC plot of samples (c_dt)
p2 <- gg$separateplots$species    + ggplot2::ylab("new title: loadings")# loadings of species  (b_k)
# Assign these plots to symbols and use grid.arrange to produce the plot  you like, for example:
gridExtra::grid.arrange(p1+ ggplot2::ylab("")+ ggplot2::xlab("week since chorpyrifos application") + ggplot2::ggtitle(""),
                        p2, ncol =2, widths = c(4,1),
                        top = "new title", left ="PRC curves of treaments", right =  "PRC species loadings")

# test significance of PRC/RDA axes ---------------------------------------

## Ditches are randomized, we have a time series, and are only
## interested in the first axis
library(vegan)
ctrl <- how(plots = Plots(strata = Design$ditch,type = "free"),
            within = Within(type = "none"), nperm = 99)

anova(mod_prc, by = "axis",permutations=  ctrl, model = "reduced", cutoff = 0.10)


}
\references{
ter Braak (2023) Redundancy analysis includes analysis of variance-simultaneous component analysis (ASCA)
 and outperforms its extensions
Chemometrics and Intelligent Laboratory Systems https://doi.org/10.1016/j.chemolab.2023.104898

ter Braak, C.J.F. & te Beest, D.E. 2022. Testing environmental effects on taxonomic composition
 with canonical correspondence analysis: alternative permutation tests are not equal.
 Environmental and Ecological Statistics. 29 (4), 849-868.
 https://doi.org/10.1007/s10651-022-00545-4

van den Brink, P.J. & ter Braak, C. (1998) Multivariate analysis of stress in experimental ecosystems
 by Principal Response Curves and similarity analysis. Aquatic Ecology, 32, 163-178.
 http://dx.doi.org/10.1023/A:1009944004756

van den Brink, P.J. & ter Braak, C.J.F. (1999) Principal Response Curves: Analysis of
 time-dependent multivariate responses of a biological community to stress.
 Environmental Toxicology and Chemistry, 18, 138-148.
 https://doi.org/10.1002/etc.5620180207

van den Brink, P.J., den Besten, P., bij de Vaate, A. & ter Braak, C.J.F. (2009)
 Principal response curves technique for the analysis of multivariate biomonitoring time series.
 Environmental Monitoring and Assessment, 152, 271-281.
 http://dx.doi.org/10.1007/s10661-008-0314-6
}
